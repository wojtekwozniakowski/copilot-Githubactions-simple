# GitHub Actions PoC: Setup and Deployment Guide

This guide covers all the steps to configure and run this GitHub Actions PoC in your repository.

## Quick Start (Local)

```bash
# Clone and install
git clone <repo-url>
cd copilot-Githubactions-simple
npm install

# Verify local build works
npm run lint
npm run format:check
npm run test
npm run build:metadata
npm run build

# Preview the app locally
npm run dev           # dev server on http://localhost:5173
npm run preview       # preview production build
```

## Prerequisites

- GitHub repository access (own or organization)
- Node.js 20+
- Basic familiarity with GitHub repositories and Actions

## Step 1: Repository Configuration

### 1.1 Enable GitHub Pages

1. Go to your repository **Settings** → **Pages**
2. Set **Source** to `GitHub Actions`
3. Save

This allows the `deploy-pages.yml` workflow to publish deployments.

### 1.2 Configure Deployment Environments (Protection Gates)

To enable manual approval before GitHub Pages deployments:

1. Go to **Settings** → **Environments**
2. Create a new environment named `github-pages` (or let GitHub create it auto-magically on first deployment)
3. Under **Protection rules**:
   - Check **Required reviewers**
   - Add GitHub users/teams who can approve deployments
   - (Optional) Check **Require status checks** to block deploy if branch doesn't pass CI

### 1.3 Configure Container Registry (GHCR Publishing)

For the `release.yml` workflow to publish Docker images:

1. Go to **Settings** → **Actions** → **General**
2. Under **Actions permissions**, ensure `Read and write permissions` is enabled
3. Ensure your organization allows package publishing to GitHub Packages (GHCR)

## Step 2: Project Structure Overview

```
.
├── .github/
│   ├── actions/
│   │   └── setup-node-project/      # Reusable composite action
│   │       └── action.yml           # Node.js setup with caching
│   └── workflows/
│       ├── ci.yml                   # CI: lint, test, build on push/PR
│       ├── deploy-pages.yml         # Deployment to GitHub Pages
│       ├── release.yml              # Release artifacts + GHCR image
│       ├── maintenance.yml          # Weekly dependency checks
│       └── codeql.yml               # Security analysis
├── src/                             # Web app source
│   ├── index.html
│   ├── main.js
│   ├── health.js
│   ├── styles.css
│   ├── build-info.template.js       # Metadata template (do not edit)
│   └── generated-build-info.js      # Generated by build script
├── scripts/
│   └── generate-build-metadata.mjs  # Injects build metadata
├── tests/
│   └── health.test.js
├── docs/
│   └── diagrams.md                  # Architecture diagrams
├── Dockerfile                       # Container image definition
├── package.json                     # Node.js dependencies
├── vite.config.js                   # Build config
└── eslint.config.js                 # Linting config
```

## Step 3: First Deployment

### Option A: Manual Test Deploy

1. Push this repo to GitHub (if not already)
2. Go to **Actions** tab
3. Select **Deploy Web App (GitHub Pages)** workflow
4. Click **Run workflow** → **Run workflow**
5. Monitor the run
6. Once complete, visit the deployment URL shown in the job logs

### Option B: Automatic Deploy (via push)

1. Commit and push any change to `main` branch
2. The `deploy-pages.yml` workflow triggers automatically
3. If you've configured environment protection, **approve the deployment** when prompted in the environment details
4. Once approved/complete, your app is live at `https://<username>.github.io/<repo>/`

## Step 4: Testing the Full CI Pipeline

1. Create a feature branch: `git checkout -b feature/test`
2. Make a small change (e.g., update text in `src/index.html`)
3. Commit and push: `git push origin feature/test`
4. Open a **Pull Request** on GitHub
5. The `ci.yml` workflow runs automatically:
   - **Lint & format checks** on Node 20 and 22
   - **Unit tests** + coverage
   - **Dependency review** (PR-only)
   - **Security audit** (`npm audit`)
   - **Artifacts** uploaded (dist, coverage)
6. Review the **Checks** tab to see results
7. Merge the PR when CI passes

## Step 5: Creating a Release

### Via Git Tag (Recommended)

```bash
git tag v0.2.0
git push origin v0.2.0
```

The `release.yml` workflow:

- Builds the app with `DEPLOY_ENV=release`
- Creates a tarball (`webapp-v0.2.0.tar.gz`) + SHA256 checksums
- Publishes a GitHub Release with auto-generated release notes
- Builds and pushes a Docker image to GHCR (`ghcr.io/<owner>/github-actions-webapp-poc:v0.2.0` and `:latest`)

### Via Manual Dispatch

1. Go to **Actions** → **Release and Publish**
2. Click **Run workflow**
3. Enter tag name (e.g., `v0.2.0`)
4. Choose whether to publish the Docker image
5. Run

## Step 6: View Maintenance & Security Reports

### Weekly Maintenance Check

The `maintenance.yml` workflow runs every Monday at 8 AM UTC:

1. Go to **Actions** → **Maintenance**
2. Select the latest run
3. Check the job summary for:
   - Outdated packages (`npm outdated`)
   - Moderate/high vulnerability report (`npm audit`)

### CodeQL Security Analysis

The `codeql.yml` workflow runs:

- On push to `main`
- On all PRs
- Weekly (Tuesday 3:30 AM UTC)

Results appear in the **Security** → **Code scanning** tab.

## Configuration & Customization

### Change Node.js Versions

Edit `.github/workflows/ci.yml`:

```yaml
strategy:
  matrix:
    node-version: [18, 20, 22] # Add/remove versions
```

### Disable Container Image Publishing

In `.github/workflows/release.yml`, remove the `publish-container` job entirely.

### Add Slack Notifications

The workflows currently generate **step summaries** visible in GitHub Actions. To add Slack:

1. In your Slack workspace, create an Incoming Webhook
2. Add `SLACK_WEBHOOK_URL` secret to repository
3. Add a notification step:

   ```yaml
   - name: Notify Slack
     if: always()
     run: |
       curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
         -H 'Content-Type: application/json' \
         -d '{"text":"Deployment: ${{ job.status }}"}'
   ```

### Custom Deployment Target

To deploy to **AWS/Azure/GCP** instead of (or in addition to) GitHub Pages:

1. Add cloud OIDC credentials as repository secrets
2. Modify `deploy-pages.yml` or create `deploy-cloud.yml`
3. Use cloud provider's GitHub Actions integration (e.g., `aws-actions/configure-aws-credentials`)

See [AWS OIDC docs](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect) for examples.

## Troubleshooting

### Build Fails Locally

```bash
# Clean install
rm -rf node_modules package-lock.json
npm install
npm run lint
npm run test
npm run build
```

### GitHub Pages Not Updating

1. Check `deploy-pages.yml` workflow in **Actions** tab
2. Ensure **GitHub Pages source** is set to `GitHub Actions` (not branch)
3. Manually trigger: **Actions** → **Deploy Web App** → **Run workflow**

### GHCR Image Push Fails

1. Verify `GITHUB_TOKEN` access (usually automatic)
2. Check repository settings: **Actions** → **General** → **Read and write permissions** enabled
3. Confirm organization allows package publishing

### Environment Protection Not Asking for Approval

1. Go to **Settings** → **Environments** → **github-pages**
2. Check **Protection rules** section
3. Ensure **Required reviewers** is enabled with users/teams assigned
4. Try a new workflow run; should pause at deployment step

## Key Workflows Explained

| Workflow           | Trigger                 | Purpose                 | Output                      |
| ------------------ | ----------------------- | ----------------------- | --------------------------- |
| `ci.yml`           | Push, PR, manual        | Code quality & security | Artifacts (dist, coverage)  |
| `deploy-pages.yml` | Push to main, manual    | GitHub Pages deployment | Live website                |
| `release.yml`      | Tag or manual           | Release bundle + Docker | GitHub Release + GHCR image |
| `maintenance.yml`  | Weekly cron, manual     | Dependency health check | Step summary report         |
| `codeql.yml`       | Push/PR to main, weekly | Security code analysis  | Security alerts             |

## Next Steps

1. **Try a PR:** Push changes and watch CI run
2. **Deploy:** Merge to main and verify Pages deployment
3. **Release:** Create a tag and see release artifacts
4. **Extend:** Use the architecture as a template for your own projects

## Resources

- [GitHub Actions Docs](https://docs.github.com/en/actions)
- [Workflow Syntax](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)
- [Composite Actions](https://docs.github.com/en/actions/creating-actions/creating-a-composite-action)
- [GitHub Pages Deployments](https://docs.github.com/en/actions/deployment/about-deployments/deploying-with-github-actions)
- [GHCR Publishing](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry)

## Support

If workflows fail, check:

1. **Actions logs:** GitHub → Actions tab → workflow run → job logs
2. **ESLint errors:** `npm run lint`
3. **Test failures:** `npm run test`
4. **Build issues:** `npm run build` (after `npm run build:metadata`)
